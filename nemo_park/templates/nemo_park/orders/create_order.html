{% extends 'nemo_park/base.html' %}

{% block title %}–ù–æ–≤—ã–π –∑–∞–∫–∞–∑{% endblock %}

{% block content %}
<div class="order-page">
    <div class="order-header">
        <a href="{% url 'orders' %}" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º</a>
        <h2 class="page-title">üõí –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
    </div>
    
    <div class="order-container">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –ú–µ–Ω—é -->
        <div class="menu-section">
            <h3>üçï –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã</h3>
            
            {% for category_name, category_products in categories.items %}
            <div class="menu-category">
                <h4 class="category-title">{{ category_name }}</h4>
                <div class="menu-items">
                    {% for product in category_products %}
                    <div class="menu-item" 
                         data-id="{{ product.id }}" 
                         data-name="{{ product.name }}" 
                         data-price="{{ product.price }}" 
                         data-emoji="{{ product.image_emoji }}"
                         onclick="addItemFromElement(this)">
                        <span class="item-emoji">{{ product.image_emoji }}</span>
                        <div class="item-info">
                            <span class="item-name">{{ product.name }}</span>
                            <span class="item-price">{{ product.price }} ‚ÇΩ</span>
                        </div>
                        <button type="button" class="add-btn">+</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –ö–æ—Ä–∑–∏–Ω–∞ -->
        <div class="cart-section">
            <h3>üßæ –ö–æ—Ä–∑–∏–Ω–∞</h3>
            
            <form method="post" id="order-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label>üë§ –ü–æ—Å–µ—Ç–∏—Ç–µ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <select name="visitor" class="form-control">
                        <option value="">-- –ë–µ–∑ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª—è --</option>
                        {% for visitor in visitors %}
                        <option value="{{ visitor.id }}">{{ visitor.first_name }} {{ visitor.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="cart-items" id="cart-items">
                    <div class="empty-cart">
                        <span>üõí</span>
                        <p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                    </div>
                </div>
                
                <div class="cart-total">
                    <span>–ò—Ç–æ–≥–æ:</span>
                    <span class="total-price" id="total-price">0 ‚ÇΩ</span>
                </div>
                
                <div class="form-group">
                    <label>üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                    <textarea name="notes" class="form-control" rows="2" placeholder="–û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è..."></textarea>
                </div>
                
                <input type="hidden" name="order_items" id="order-items-input">
                
                <div class="cart-actions">
                    <button type="submit" class="btn btn-success btn-block" id="submit-btn" disabled>
                        ‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                    <button type="button" class="btn btn-secondary btn-block" onclick="clearCart()">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .order-page { max-width: 1200px; margin: 0 auto; }
    .order-header { margin-bottom: 25px; }
    .back-link { color: #0077B6; text-decoration: none; font-weight: 600; }
    .back-link:hover { color: #FF6B35; }
    
    .order-container { display: grid; grid-template-columns: 1fr 400px; gap: 30px; }
    
    /* –ú–µ–Ω—é */
    .menu-section { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
    .menu-section h3 { color: #023E8A; margin-bottom: 20px; }
    .menu-category { margin-bottom: 25px; }
    .category-title { color: #FF6B35; font-size: 1rem; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #FF6B35; }
    .menu-items { display: flex; flex-direction: column; gap: 10px; }
    .menu-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; background: #f8fafc; border-radius: 12px; transition: all 0.2s ease; cursor: pointer; }
    .menu-item:hover { background: #e8f4fd; transform: translateX(5px); }
    .item-emoji { font-size: 1.8rem; }
    .item-info { flex: 1; }
    .item-name { display: block; font-weight: 600; color: #333; }
    .item-price { font-size: 0.9rem; color: #00b894; font-weight: 700; }
    .add-btn { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #00b894, #00cec9); color: white; border: none; font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0; }
    .add-btn:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,184,148,0.4); }
    
    /* –ö–æ—Ä–∑–∏–Ω–∞ */
    .cart-section { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); position: sticky; top: 20px; height: fit-content; }
    .cart-section h3 { color: #023E8A; margin-bottom: 20px; }
    .cart-items { min-height: 200px; max-height: 350px; overflow-y: auto; margin-bottom: 20px; }
    .empty-cart { text-align: center; padding: 40px 20px; color: #999; }
    .empty-cart span { font-size: 3rem; display: block; margin-bottom: 10px; }
    
    .cart-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 10px; }
    .cart-item-emoji { font-size: 1.5rem; }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-weight: 600; font-size: 0.9rem; }
    .cart-item-price { font-size: 0.85rem; color: #00b894; }
    .cart-item-qty { display: flex; align-items: center; gap: 8px; }
    .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: none; cursor: pointer; font-weight: bold; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0; }
    .qty-btn.none { background: #dadada; color: #909090; cursor: not-allowed; opacity: 0.6; }
    .qty-btn.minus { background: #fee2e2; color: #e74c3c; }
    .qty-btn.plus { background: #d4edda; color: #00b894; }
    .qty-btn:hover { transform: scale(1.1); }
    .qty-value { font-weight: 700; min-width: 24px; text-align: center; }
    .remove-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.5; }
    .remove-btn:hover { opacity: 1; }
    
    .cart-total { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: linear-gradient(135deg, #023E8A, #0077B6); border-radius: 12px; color: white; margin-bottom: 20px; }
    .total-price { font-size: 1.5rem; font-weight: 800; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #023E8A; font-size: 0.9rem; }
    .form-control { width: 100%; padding: 12px; border: 2px solid #e8e8e8; border-radius: 10px; font-size: 1rem; }
    .form-control:focus { border-color: #0077B6; outline: none; }
    
    .cart-actions { display: flex; flex-direction: column; gap: 10px; }
    .btn-block { width: 100%; justify-content: center; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    @media (max-width: 900px) {
        .order-container { grid-template-columns: 1fr; }
        .cart-section { position: static; }
    }
</style>

<script>
// –ö–æ—Ä–∑–∏–Ω–∞
var cart = [];

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ data-–∞—Ç—Ä–∏–±—É—Ç—ã —ç–ª–µ–º–µ–Ω—Ç–∞
function addItemFromElement(element) {
    var id = parseInt(element.getAttribute('data-id'));
    var name = element.getAttribute('data-name');
    var price = parseFloat(element.getAttribute('data-price'));
    var emoji = element.getAttribute('data-emoji');
    
    addToCart(id, name, price, emoji);
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
function addToCart(id, name, price, emoji) {
    var existing = null;
    for (var i = 0; i < cart.length; i++) {
        if (cart[i].product_id === id) {
            existing = cart[i];
            break;
        }
    }
    
    if (existing) {
        existing.quantity++;
    } else {
        cart.push({
            product_id: id,
            name: name,
            price: price,
            emoji: emoji,
            quantity: 1
        });
    }
    updateCartUI();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
function removeFromCart(id) {
    var newCart = [];
    for (var i = 0; i < cart.length; i++) {
        if (cart[i].product_id !== id) {
            newCart.push(cart[i]);
        }
    }
    cart = newCart;
    updateCartUI();
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
function updateQuantity(id, delta) {
    for (var i = 0; i < cart.length; i++) {
        if (cart[i].product_id === id) {
            cart[i].quantity += delta;
            if (cart[i].quantity > 250) {
                cart[i].quantity = 250;
                return;
            }
            if (cart[i].quantity <= 0) {
                removeFromCart(id);
                return;
            }
            break;
        }
    }
    updateCartUI();
}

// –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
function clearCart() {
    cart = [];
    updateCartUI();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–æ—Ä–∑–∏–Ω—ã
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –∫–æ—Ä–∑–∏–Ω—ã
function updateCartUI() {
    var container = document.getElementById('cart-items');
    var totalEl = document.getElementById('total-price');
    var inputEl = document.getElementById('order-items-input');
    var submitBtn = document.getElementById('submit-btn');
    
    if (cart.length === 0) {
        container.innerHTML = '<div class="empty-cart"><span>üõí</span><p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p></div>';
        totalEl.textContent = '0 ‚ÇΩ';
        inputEl.value = '[]';
        submitBtn.disabled = true;
        return;
    }
    
    var html = '';
    var total = 0;
    
    for (var i = 0; i < cart.length; i++) {
        var item = cart[i];
        var itemTotal = item.price * item.quantity;
        total += itemTotal;
        
        var isMaxReached = item.quantity > 250;
        var plusBtnClass = isMaxReached ? 'qty-btn plus none' : 'qty-btn plus';
        var plusBtnDisabled = isMaxReached ? ' none' : '';
        
        html += '<div class="cart-item">';
        html += '<span class="cart-item-emoji">' + item.emoji + '</span>';
        html += '<div class="cart-item-info">';
        html += '<div class="cart-item-name">' + item.name + '</div>';
        html += '<div class="cart-item-price">' + item.price + ' ‚ÇΩ √ó ' + item.quantity + ' = ' + itemTotal + ' ‚ÇΩ</div>';
        html += '</div>';
        html += '<div class="cart-item-qty">';
        html += '<button type="button" class="qty-btn minus" onclick="updateQuantity(' + item.product_id + ', -1)">‚àí</button>';
        html += '<span class="qty-value">' + item.quantity + '</span>';
        html += '<button type="button" class="' + plusBtnClass + '"' + plusBtnDisabled + ' onclick="updateQuantity(' + item.product_id + ', 1)">+</button>';
        html += '</div>';
        html += '<button type="button" class="remove-btn" onclick="removeFromCart(' + item.product_id + ')">üóëÔ∏è</button>';
        html += '</div>';
    }
    
    container.innerHTML = html;
    totalEl.textContent = total + ' ‚ÇΩ';
    inputEl.value = JSON.stringify(cart);
    submitBtn.disabled = false;
}
</script>
{% endblock %}